# Build #34: The Nuclear Option (ROCm 6.2 Edition)
# Goal: Build PyTorch and vLLM from source for gfx1151 using stable ROCm 6.2.4
# Base Image: Official AMD ROCm 6.2.4 Development Image (Ubuntu 24.04)

FROM docker.io/rocm/dev-ubuntu-24.04:6.2.4

# Set environment variables for non-interactive install
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# 1. Install System Dependencies
# We need python3.12 (default in Ubuntu 24.04), git, cmake, ninja
RUN apt-get update && apt-get install -y \
    python3-pip \
    python3-dev \
    python3-venv \
    git \
    cmake \
    ninja-build \
    libnuma-dev \
    libsndfile1 \
    libtinfo-dev \
    libxml2-dev \
    libedit-dev \
    rocrand-dev \
    rocprim-dev \
    hiprand-dev \
    rocblas-dev \
    hipblas-dev \
    rocfft-dev \
    rocsolver-dev \
    rocsparse-dev \
    miopen-hip-dev \
    hipblaslt-dev \
    rccl-dev \
    hipfft-dev \
    hipsolver-dev \
    hipsparse-dev \
    rocthrust-dev \
    hipcub-dev \
    && rm -rf /var/lib/apt/lists/*

# 2. Setup Python Environment
# Create a virtual environment to avoid system package conflicts
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install build dependencies
RUN pip install --no-cache-dir --upgrade pip setuptools wheel packaging

# 3. Clone PyTorch (Stable v2.5.1)
WORKDIR /app
# We use the 'release/2.5' branch or 'v2.5.1' tag. 
# Using recursive clone for submodules.
RUN git clone --recursive --branch v2.5.1 --depth 1 https://github.com/pytorch/pytorch.git

# 4. Build PyTorch from Source
WORKDIR /app/pytorch

# Install PyTorch build requirements
RUN pip install --no-cache-dir -r requirements.txt

# Configure Build Options for ROCm 6.2 + gfx1151
# We explicitly target gfx1151. If the compiler fails, we might need to fallback to gfx1100.
ENV PYTORCH_ROCM_ARCH="gfx1151"
# Restrict aotriton to gfx1151 to prevent linker errors (relocation out of range)
ENV AOTRITON_GPU_TARGETS="gfx1151"
# Force medium code model to handle large binaries if they still occur
ENV CFLAGS="-mcmodel=medium"
ENV CXXFLAGS="-mcmodel=medium"
ENV USE_ROCM=1
ENV MAX_JOBS=16

# Run the hipify script explicitly (lesson learned from Build #33)
# Note: In 2.5.1, the path might be slightly different or handled automatically, 
# but running it manually is safer based on previous experience.
RUN python3 tools/amd_build/build_amd.py || true

# Build and Install
RUN python3 setup.py install

# 5. Clone vLLM (Stable v0.10.3)
WORKDIR /app
RUN git clone --branch v0.10.3 --depth 1 https://github.com/vllm-project/vllm.git

# 6. Build vLLM from Source
WORKDIR /app/vllm

# Install vLLM build dependencies
RUN pip install --no-cache-dir -r requirements-rocm.txt

# Configure Build Options
ENV ROCM_HOME="/opt/rocm"
ENV HIP_SUPPORTED_ARCHS="gfx1151"
ENV VLLM_TARGET_DEVICE="rocm"

# Build and Install
RUN pip install .

# 7. Final Verification
RUN python3 -c "import torch; print(f'PyTorch: {torch.__version__}'); import vllm; print(f'vLLM: {vllm.__version__}')"

# Set default command
CMD ["/bin/bash"]
